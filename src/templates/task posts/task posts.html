<!-- Utilizamos las propiedades de flask "extends", para poder heredar las propiedades del archivo principal base 
que contiene los links principales del javaScripts y Css, para brindar los estilos a los demas modulos
-->
{%extends './base.html' %}

<!-- En esta sección personalizamos asignaremos la ruta de los estilos personalizados para este modulo-->
{% block links %}
<link rel="stylesheet" href="../static/css/styles/style-process.css"> {%endblock%}

<!-- En esta sección personalizamos el titulo correspondiente a cada modulo en el que nos encontremos-->
{%block title%}Pagina principal.{%endblock%}

<!-- Utilizando las propiedades block, definiendo el la sección body, podemos insertar la estructura principal html, para 
poder personalizar y ahorrar lineas de codigo en los modulos
-->
{%block body%}

<!-- Inicio contenido principal del modulo "home"-->

<body class="bodyPrincipal">
    <br>
    <!-- Contenido principal "En desarrollo..."-->
    <div class="container3">
        <div class="container4">
            <!-- Sección de cabecera del contenedor de los procesos -->
            <br>
            <div class="containerHead">
                <div class="container-search-bar">
                    <div class="item item-1">
                        <input type="text" placeholder="Escriba el nombre del proceso..." id="buscador">
                    </div>
                    <div class="item item-2">
                        <i class="search-icon fa-solid fa-magnifying-glass"></i>
                    </div>
                </div>
        
                <div class="containerButomGenerate">
                    <button type="button" data-bs-toggle="modal" data-bs-target="#ModalCrearproceso"
                    class="butomGenerate "> <i class="fa-solid fa-plus"></i> </button>
                </div>
            </div>
            <!-- Fin sección de cabecera del contenedor de los procesos -->
            <!------------------------------------------------------------------------------------------------------------------------------------>

            <!-- Inicio modal-1 crear posts -->
            <div class="modal fade" id="ModalCrearproceso" tabindex="-1" aria-labelledby="ModalCrearproceso"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Nuevo proceso.</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <!-- Cuerpo del modal donde encontramos el formualrio con los datos del usario -->
                        <div class="modal-body">
                            <form action="/addPosts" method="POST">
                                <div class="row mb-3">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                    <label>Titulo: *</label>
                                    <input type="text" class="form-control mb-3" name="Titulo" required>

                                    <label>Descripción: </label>
                                    <input type="text" class="form-control mb-3" name="Descripcion">

                                    <label>Fecha de Inicio:</label>
                                    <input type="date" class="form-control mb-3" id="fecha" name="fecha_I" readonly>

                                    <label>Fecha Limite:</label>
                                    <input type="date" class="form-control mb-3" id="fecha" name="fecha_L">

                                    <hr>
                                    <label>Nivel de importancia: </label>
                                    <div class="ContentInputSelect">
                                        <!-- The second value will be selected initially -->
                                        <select name="select" class="InputSelect">
                                            <option value="1" class="Optionselect">Bajo </option>
                                            <option value="2" class="Optionselect">Medio </option>
                                            <option value="3" class="Optionselect">Alto </option>
                                        </select>
                                    </div>
                                    <hr>
                                    <div class="desplagable_1">
                                        <button class="btnAsignar" type="button" data-bs-toggle="dropdown"
                                            aria-expanded="false"><i class="fa-solid fa-user"></i> Asignar
                                            personal...</button>
                                        <ul class="deplegableNombres dropdown-menu">
                                            {% for Usuario in datosU %}
                                            <li class="elementoLista">
                                                <input type="checkbox" class="usuariosSelect"
                                                    name="usuarios_seleccionados" value="{{ Usuario.id_usuarios }}"
                                                    id="{{Usuario.id_usuarios}}">
                                                <label for="{{Usuario.id_usuarios}}" id="AsignarUsu" class="NombreUsuario">
                                                    {{Usuario.Nombre_completo}}
                                                </label>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <br><br>
                                    <div class="modal-footer">
                                        <button type="button" class="secundario btn btn-secondary"
                                            data-bs-dismiss="modal">Cerrar</button>
                                        <button type="submit" class="principal btn btn-primary">Guardar</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin modal-1 crear posts -->
            <!------------------------------------------------------------------------------------------------------------------------------------>


            <!------------------------------------------------------------------------------------------------------------------------------------>
            <!-- Apartado principal donde se optiene los datos iterados con base a el diccionario renderizado en data-->
            {% for datos in data %}
            <!------------------------------------------------------------------------------------------------------------------------------------>
            <!-- Apartado de posts -->
            <div class="contenedorprin">
                <main>
                    <section class="section-main-container">
                        <div class="titleC">
                            <i class="iconoE fa-solid fa-pencil" id="btn-edit{{datos.id_proceso}}"
                                data-bs-toggle="modal" data-bs-target="#modal{{datos.id_proceso}}"></i>
                            <a href="#" class="eliminarProceso"
                                data-url="{{ url_for('eliminarP', idP=datos.id_proceso) }}">
                                <i class="iconoD fa-solid fa-trash"></i>
                            </a>
                            <h1 class="titleP">{{datos.Titulo}}</h1>
                        </div>
                        <div class="info-container">
                            <div class="description">
                                <p class="descriptiontext">
                                    {{datos.Descripcion}}
                                </p>
                            </div>
                            <div class="nameUser">
                                {% if datos.nombre_usuario %}
                                <button class="btnAsignar2" type="button" data-bs-toggle="dropdown"
                                    aria-expanded="false">Asignado
                                    <i class="fa-regular fa-user"></i>.
                                </button>
                                <ul class="dropdown-menu" id="submenu">
                                    {% for usuario in datos.nombre_usuario %}
                                    <label id="AsignarUsu" class="UsuariosAsignados">
                                        {{ usuario }}
                                    </label>
                                    <br>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="Texto-importancia">Ningún usuario asignado
                                    <i class="fa-solid fa-user-slash">.</i>
                                </p>
                                {% endif %}
                            </div>
                            <div class="moreInfo">
                                <button class="btnAsignar2" type="button" data-bs-toggle="modal"
                                    data-bs-target="#modal-3{{datos.id_proceso}}" aria-expanded="false">Ver más
                                    <i class="fa-regular fa-eye"></i>...
                            </div>
                            <div class="important-user">
                                <p class="Texto-importancia">
                                    Nivel importancia:
                                    {% for nivel in range(datos.Nivel_importancia) %}
                                    <i class="fa-regular fa-star"></i>
                                    {% endfor %}
                                </p>
                            </div>
                        </div>

                        <div class="div-bottom-container">
                            <div class="hr-container">
                                <progress value="{{datos.progreso}}" min="10" max="100"
                                    class="{% if datos.progreso <= 30 %}progress-low{% elif datos.progreso <= 75 %}progress-medium{% else %}progress-high{% endif %}"></progress>
                            </div>
                            {% if not datos.ReporteGenerado %}
                            <div class="button-right">
                                <button class="buttonGreporte" data-bs-toggle="modal"
                                    data-bs-target="#modal-4{{datos.id_proceso}}">
                                    Generar reporte...</button>
                            </div>
                            {% else %}
                            <div class="button-right">
                                <button class="buttonA">
                                    <a href="../static/pdf/{{datos.ReporteGenerado}}"> Ver reporte...</a>
                                </button>
                                <button class="buttonB">
                                    <a class="eliminarReporte"
                                        data-url="{{ url_for('eliminarR', idP=datos.id_proceso) }}">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="">
                            <p class="numeroid">
                                N° {{datos.id_proceso}}
                            </p>
                        </div>
                    </section>
                </main>
            </div>
            <!-- Fin apartado posts -->
            <!------------------------------------------------------------------------------------------------------------------------------------>

            <!-- Modal 2 De vista de los datos del proceso. -->
            <div class="modal fade" id="modal-3{{datos.id_proceso}}" tabindex="-1" aria-labelledby="exampleModalLabel-3"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <!-- Encabezado del proceso-->
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">{{datos.Titulo}}</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <!-- Cuerpo del modal donde encontramos el formualrio con los datos del usario. -->
                        <div class="modal-body">
                            <!-- Descripción del proceso. -->
                            <p class="text-break">
                                {{datos.Descripcion}}
                            </p>
                            <hr>
                            <!-- Periodo de fechas del proceso. -->
                            <p class="text-break">
                                Periodo de fechas del proceso: <br> {{datos.fecha_inicio}} // {{datos.fecha_limite}}
                            </p>
                            <hr>
                            <!-- Apartado donde se observan los días faltantes del proceso. -->
                            {% if datos.diferencia_dias <= 0 %} <p>Proceso cerrado por fecha limite.</p>

                                {% elif datos.diferencia_dias > 0 and datos.diferencia_dias < 2 %} <p>Queda
                                    {{datos.diferencia_dias}} día, para terminar el proceso.</p>

                                    {% elif datos.diferencia_dias > 1 %}
                                    <p>Quedan {{datos.diferencia_dias}} días, para terminar el proceso.</p>
                                    {% endif %}
                                    <hr>
                                    <!-- Estado del proceso actual. -->
                                    <p>
                                        {% if datos.estado_proceso == 1 %}
                                        Proceso abierto.
                                        {% elif datos.estado_proceso == 2 %}
                                        Proceso cerrado.
                                        {% elif datos.estado_proceso == 3 %}
                                        Proceso vencido por tiempo.
                                        {% endif%}
                                    </p>
                                    <hr>
                                    <!-- Nivel de importancia del proceso actual, representado por la cantidad de estrellas. -->
                                    <p>
                                        Nivel importancia:
                                        {% for nivel in range(datos.Nivel_importancia) %}
                                        <i class="fa-regular fa-star"></i>
                                        {% endfor %}
                                    </p>
                                    <hr>
                                    <!-- Apartado donde observaremos el pdf en caso de que este ya se haya generado. -->
                                    {% if not datos.ReporteGenerado %}
                                    <p>Reporte pendiente.</p>
                                    {% else %}
                                    <div class="containerViewReport">
                                        <iframe class="view-report" src="../static/pdf/{{datos.ReporteGenerado}}"
                                            allow="autoplay"></iframe>
                                    </div>
                                    {% endif %}
                        </div>
                        <!-- Sección de footer del proceso-->
                        <div class="modal-footer">
                            {% if not datos.ReporteGenerado %}
                            <button class="btnReport btn btn-primary btn-sm" id="btn-edit{{datos.id_proceso}}"
                                data-bs-toggle="modal" data-bs-target="#modal-4{{datos.id_proceso}}">Generar
                                Reporte...</button>
                            {% else %}
                            <a class="Areport" href="../static/pdf/{{datos.ReporteGenerado}}"
                                download="nombre_estandar.pdf">Descargar Reporte...</a>
                            {% endif %}

                            <button class="principal btn btn-primary btn-sm" id="btn-edit{{datos.id_proceso}}"
                                data-bs-toggle="modal" data-bs-target="#modal{{datos.id_proceso}}">Editar
                                proceso</button>
                            <a href="#" class="eliminar btn btn-danger btn-sm" data-id="{{ datos.id_proceso }}"
                                data-url="{{ url_for('eliminarP', idP=datos.id_proceso) }}">Borrar proceso</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin modal-2 -->
            <!------------------------------------------------------------------------------------------------------------------------------------>


            <!-- Modal 3 para editar proceso-->
            <div class="modal fade" id="modal{{datos.id_proceso}}" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Editar proceso.</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form action="/edit/{{datos.id_proceso}}" method="post" id="formularioActualizarP"
                                enctype="multipart/form-data">
                                <!-- Campo con el token de sección -->
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <!-- Campo para diligenciar el titulo -->
                                <label>Titulo:</label>
                                <input type="text" class="form-control mb-3" name="Titulo" value="{{datos.Titulo}}"
                                    required>
                                <!-- Campo para diligenciar la descripción -->
                                <label for="descripcion">Descripción:</label>
                                <textarea class="form-control" rows="6" type="text" class="form-control mb-3"
                                    name="Descripcion">{{datos.Descripcion}}</textarea>
                                <br>
                                <label>Nivel de importancia: </label>
                                <div class="ContentInputSelect">
                                    <!-- Boton de selección unilateral -->
                                    <select name="selectI" id="" class="InputSelect">
                                        <option value="1" class="Optionselect" {% if datos.Nivel_importancia==1
                                            %}selected{% endif %}>Bajo </option>
                                        <option value="2" class="Optionselect" {% if datos.Nivel_importancia==2
                                            %}selected{% endif %}>Medio </option>
                                        <option value="3" class="Optionselect" {% if datos.Nivel_importancia==3
                                            %}selected{% endif %}>Alto </option>
                                    </select>
                                </div>
                                <hr>
                                <label>Estado del proceso: </label>
                                <div class="ContentInputSelect">
                                    <!-- Boton de selección unilateral -->
                                    <select name="selectP" id="SelectLevel" class="InputSelect">
                                        <option value="1" class="Optionselect" {% if datos.estado_proceso==1
                                            %}selected{% endif %}>Abierto </option>
                                        <option value="2" class="Optionselect" {% if datos.estado_proceso==2
                                            %}selected{% endif %}>Finalizado </option>
                                        <option value="3" class="Optionselect" {% if datos.estado_proceso==3
                                            %}selected{% endif %}>Vencido </option>
                                    </select>
                                </div>
                                <hr>
                                <!-- Campo donde se observar los usuarios asignados -->
                                <label>Personal asignado:</label>
                                <br>
                                {% if datos.nombre_usuario %}
                                <div class="NombreAsignado">
                                    {% for usuario in datos.nombre_usuario %}
                                    {% if usuario %}
                                    <label>
                                        {{ usuario }}
                                    </label>
                                    <!-- Si usuario es una cadena, entonces aplica split -->
                                    {% if usuario is string %}
                                    <button type="submit" class="btnEliminarAsignacion" data-id="{{ datos.id_proceso }}"
                                        data-id-asignado="{{ datos.id_usuario[loop.index0] }}">
                                        <i class="iconoX fa-solid fa-xmark"></i>
                                    </button>
                                    <br>
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p>Ningún usuario asignado.</p>
                                {% endif %}
                                <hr>
                                <!-- Campo donde se observar los usuarios No asignados y disponibles -->
                                <div class="deplegable_1">
                                    <div class="dropdown">
                                        <button class="btnAsignar desplegable-toggle"><i class="fa-solid fa-user"></i>
                                            Actualizar asignados</button>
                                        <ul class="dropdown-menu">
                                            <br>
                                            <!---------------------------------------------------------->
                                            {% for Usuario in datosU %}
                                            {% if Usuario.id_usuarios not in datos.id_usuarios %}
                                            <li class="labelAsignados">
                                                <label>
                                                    <input type="checkbox" class="checkbox_nombres"
                                                        name="usuarios_seleccionados_2"
                                                        value="{{ Usuario.id_usuarios }}">
                                                    <span class="PersonalAsignados">{{Usuario.Nombre_completo}}</span>
                                                    <br><br>
                                                </label>
                                            </li>
                                            {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <br>
                                <div class="modal-footer">
                                    <button type="button" class="secundario btn btn-secondary"
                                        data-bs-dismiss="modal">Cerrar</button>
                                    <button type="submit" class="principal btn btn-primary">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin modal-3 -->
            <!------------------------------------------------------------------------------------------------------------------------------------>


            <!-- Modal 4 Generar reporte -->
            <div class="modal fade" id="modal-4{{datos.id_proceso}}" tabindex="-1" aria-labelledby="exampleModalLabel-3"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Generar reporte</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <!-- Cuerpo del modal donde encontramos el formualrio con los datos del usario -->
                        <div class="modal-body">
                            <form method="POST" action="/generar_reporte" enctype="multipart/form-data">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <label>Titulo:</label>
                                <input type="text" class="form-control mb-3" name="titulo" value="">
                                <label>Descripción:</label>
                                <input type="text" class="form-control mb-3" name="descripcion" value="">
                                <input type="hidden" name="idProceso" value="{{datos.id_proceso}}">
                                <input type="hidden" name="EstadoProceso" value="2">

                                <!-- Botón donde podremos subir el archivo con la foto del perfil -->
                                <div class="mb-3">
                                    <label for="formFileSm" class="form-label">Evidencia fotografica:</label>
                                    <input class="form-control form-control-sm" id="formFileSm" type="file"
                                        name="archivo">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="secundario btn btn-secondary"
                                        data-bs-dismiss="modal">Cerrar</button>
                                    <button type="submit" class="principal btn btn-primary">Generar reporte</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin modal-4 -->
            {% endfor %}
        </div>
    </div>
    <br>
</body>

{% block scripts %}<script src="../static/js/procesos.js"></script>{%endblock%}

<!-- Fin contenido principal del modulo "home"-->
{%endblock%}